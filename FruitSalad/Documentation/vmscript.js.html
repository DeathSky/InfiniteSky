<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=yes, width=device-width">
  <title>InfiniteSky â€” Source: VMScript.js</title>
  <link rel="shortcut icon" href="/favicon.ico">

  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link type="text/css" rel="stylesheet" href="styles/sunlight.dark.css">

  <link type="text/css" rel="stylesheet" href="styles/site.oblivion.css">
</head>
<body>
<div class="container-fluid">
  <div class="navbar navbar-fixed-top navbar-inverse">
    <div class="navbar-inner">
      <a class="brand" href="index.html">InfiniteSky</a>
      <ul class="nav">
        
        <li class="dropdown">
          <a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
            class="caret"></b></a>

          <ul class="dropdown-menu ">
            
            <li>
              <a href="Zone_recv.html">Zone/recv</a>
            </li>
            
            <li>
              <a href="Zone_send.html">Zone/send</a>
            </li>
            

          </ul>
        </li>
        
        <li class="dropdown">
          <a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
            class="caret"></b></a>

          <ul class="dropdown-menu ">
            
            <li>
              <a href="module-Helper_ChildProcessHost.html">Helper/ChildProcessHost</a>
            </li>
            
            <li>
              <a href="module-LoginInstance.html">LoginInstance</a>
            </li>
            
            <li>
              <a href="module-PacketCollection.html">PacketCollection</a>
            </li>
            
            <li>
              <a href="module-Restruct.html">Restruct</a>
            </li>
            
            <li>
              <a href="module-vmscript.html">vmscript</a>
            </li>
            
            <li>
              <a href="module-ZoneInstance.html">ZoneInstance</a>
            </li>
            

          </ul>
        </li>
        
        <li class="dropdown">
          <a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
            class="caret"></b></a>

          <ul class="dropdown-menu ">
            
            <li>
              <a href="CharacterInfos.html">CharacterInfos</a>
            </li>
            
            <li>
              <a href="Command.html">Command</a>
            </li>
            
            <li>
              <a href="CVec3.html">CVec3</a>
            </li>
            
            <li>
              <a href="db.Account.html">db.Account</a>
            </li>
            
            <li>
              <a href="db.Item.html">db.Item</a>
            </li>
            
            <li>
              <a href="module-Helper_ChildProcessHost-ChildProcessHost.html">Helper/ChildProcessHost~ChildProcessHost</a>
            </li>
            
            <li>
              <a href="module-vmscript-VMScriptObj.html">vmscript~VMScriptObj</a>
            </li>
            

          </ul>
        </li>
        
        <li class="dropdown">
          <a href="mixins.list.html" class="dropdown-toggle" data-toggle="dropdown">Mixins<b
            class="caret"></b></a>

          <ul class="dropdown-menu ">
            
            <li>
              <a href="-_anonymous_-structs.CVec3.html"><anonymous>~structs.CVec3</a>
            </li>
            

          </ul>
        </li>
        
        <li class="dropdown">
          <a href="tutorials.list.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b
            class="caret"></b></a>

          <ul class="dropdown-menu ">
            
            <li>
              <a href="tutorial-command_.html">command</a>
            </li>
            
            <li>
              <a href="tutorial-Project Layout.html">Project Layout</a>
            </li>
            

          </ul>
        </li>
        
        <li class="dropdown">
          <a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
            class="caret"></b></a>

          <ul class="dropdown-menu ">
            
            <li>
              <a href="global.html#_id">_id</a>
            </li>
            
            <li>
              <a href="global.html#autocomplete">autocomplete</a>
            </li>
            
            <li>
              <a href="global.html#calculation">calculation</a>
            </li>
            
            <li>
              <a href="global.html#DamageDealer">DamageDealer</a>
            </li>
            
            <li>
              <a href="global.html#defaultPacketFunction">defaultPacketFunction</a>
            </li>
            
            <li>
              <a href="global.html#deg2rad">deg2rad</a>
            </li>
            
            <li>
              <a href="global.html#FujinModifiers">FujinModifiers</a>
            </li>
            
            <li>
              <a href="global.html#GuanyinModifiers">GuanyinModifiers</a>
            </li>
            
            <li>
              <a href="global.html#JinongModifiers">JinongModifiers</a>
            </li>
            
            <li>
              <a href="global.html#NanginTrack_Countdown">NanginTrack_Countdown</a>
            </li>
            
            <li>
              <a href="global.html#NanginTrack_Finished">NanginTrack_Finished</a>
            </li>
            
            <li>
              <a href="global.html#NanginTrack_Init">NanginTrack_Init</a>
            </li>
            
            <li>
              <a href="global.html#NanginTrack_onLoad">NanginTrack_onLoad</a>
            </li>
            
            <li>
              <a href="global.html#NanginTrack_Start">NanginTrack_Start</a>
            </li>
            
            <li>
              <a href="global.html#ObjectId">ObjectId</a>
            </li>
            
            <li>
              <a href="global.html#rad2deg">rad2deg</a>
            </li>
            

          </ul>
        </li>
        
      </ul>
    </div>
  </div>

  <div class="row-fluid">

    

    
      <div class="span12">
        
        <div id="main">
          


		<h1 class="page-title">Source: VMScript.js</h1>
    
<section>
  <article>
    <pre
      class="sunlight-highlight-javascript linenums">/*    Copywrite Przemyslaw Walczak &amp; Liam Mitchell 2015
 *    This file is part of vmscript.
 *
 *    vmscript is free software: you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation, either version 3 of the License, or
 *    (at your option) any later version.
 *
 *    vmscript is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU General Public License for more details.
 *
 *    You should have received a copy of the GNU General Public License
 *    along with vmscript.  If not, see &lt;http://www.gnu.org/licenses/>.
 */

/**
 * A singleton module for virtalized script loading.
 * Watches scripts and reloads them at runtime.
 * @module  vmscript
 */


// TODO: Fix a memory leak due to 11 > listeners warning.

var fs = require('fs');
var EventEmitter = require('events').EventEmitter;
EventEmitter = new EventEmitter();
var vm = require('vm');
var path = require('path');

var JSONParser = require('jsonlint').parser;
var jshint = require('jshint').JSHINT;
var clc = require('cli-color');
var colors = {orange: clc.xterm(202), info: clc.xterm(33)};

/**
 * A utility function to console log an error exception.
 * @param  {Exception|String} err The error/exception.
 * @deprecated We might remove this in the future.
 */
function dumpError(err) {
  if (typeof err === 'object') {
    if (err.message) {
      console.error('\n\r\x1b[31;1mException: ' + err.message+'\x1b[0m\n\r');
    }

    // if (err.stack) {
    //   console.error('\x1b[31;1mStacktrace:\x1b[0m','\n',err.stack.split('\n').splice(1).join('\n'));
    // }
  } else {
    console.error('\x1b[31;1m' + err+'\x1b[0m');
  }
}

var array = {};
var fileStats = {};
var dependencies = {};

/**
 * VMScript Object.
 * @constructor
 */
function VMScriptObj(){
	global.vms = this.vms;
	// global.vmscript = this;
	this.readyListeners = [];

	var self = this;

	EventEmitter.on('file added', function(file_path){

		var file_name = getFilename(path.parse(file_path));
		console.log(colors.orange("[VMS]"), colors.info("added:"), file_name);

		self.parse(file_path);
	});

	EventEmitter.on('file changed', function(file_path){

		var file_name = getFilename(path.parse(file_path));
		console.log(colors.orange("[VMS]"), colors.info("changed:"), file_name);

		self.parse(file_path);
	});

	EventEmitter.on('file removed', function(file_path){
		var file_name = getFilename(path.parse(file_path));
		console.log(colors.orange("[VMS]"), colors.orange("removed:"), file_name);

		self.parse(file_path);
	});

	EventEmitter.on('dependency loaded', function(name){
		for(var i=0; i&lt;self.readyListeners.length; i++){
			var listener = self.readyListeners[i];
			if(typeof listener.name === 'object'){
				if(!listener.loaded) listener.loaded = [];
				if(listener.name.indexOf(name) > -1 &amp;&amp; listener.loaded.indexOf(name) === -1)
					listener.loaded.push(name);

				if(listener.name.length === listener.loaded.length){
					listener.callback();
					self.readyListeners.splice(i, 1);
				}
			}else{
				if(listener.name === name){
					listener.callback();
					self.readyListeners.splice(i, 1);
				}
			}
		}
	});

	EventEmitter.on('check dependencies', function(){
		for(var dependent in dependencies){
			var d = dependencies[dependent];

      var loaded;
			if(d.depends &amp;&amp; !d.running &amp;&amp; !d.hasError){
				loaded = 0;
				for(var i=0; i&lt;d.depends.length; i++){
					var dp = d.depends[i];
					if(dependencies[dp] &amp;&amp; dependencies[dp].running){
						loaded++;
					}
				}

				if(loaded === d.depends.length){
					if(d.callback){
						try{
							d.callback();
							d.running = true;
							EventEmitter.emit('check dependencies');
							EventEmitter.emit('dependency loaded', dependent);
						}catch(e){
							console.log(e);
							d.hasError = true;
						}
					}
				}
			} else if(d.files &amp;&amp; !d.running){
				loaded = 0;
				for(var i=0; i&lt;d.files.length; i++){
					var name = getFilename(path.parse(d.files[i]));
					if ( (dependencies[name] &amp;&amp; dependencies[name].running) || self[name] !== undefined || global[name] !== undefined) {
						loaded++;
					}
				}

				if(loaded === d.files.length){
					d.running = true;
					EventEmitter.emit('dependency loaded', dependent);
					EventEmitter.emit('check dependencies');
				}
			}
		}

		// Check ready listeners
		for(var i=0; i&lt;self.readyListeners.length; i++){
			var listener = self.readyListeners[i];

			if(typeof listener.name === 'object'){
				listener.loaded = [];

				for (var j = 0; j&lt; listener.name.length; j++) {
					if ((dependencies[listener.name[j]] &amp;&amp; dependencies[listener.name[j]].running) || self[listener.name[j]] !== undefined || global[listener.name[j]] !== undefined) {
						listener.loaded.push(listener.name[j]);
					}
				}

				if(listener.name.length === listener.loaded.length){
					listener.callback();
					self.readyListeners.splice(i, 1);
				}
			} else {
				if ((dependencies[listener.name] &amp;&amp; dependencies[listener.name].running) || self[listener.name] !== undefined || global[listener.name] !== undefined) {
					listener.callback();
					self.readyListeners.splice(i, 1);
				}
			}
		}


	});
};

/**
 * Reads the file contents and runs it in this context using node.js's vm.
 * This is intended to be used internally. Can parse json and js files.
 * Runs a jshint if there is a problem loading the file.
 * @param  {String|Path} file_path The file path.
 */
VMScriptObj.prototype.parse = function(file_path){
	fs.readFile(file_path, function(err, content){
		if(err){
			// console.log(err);
			return;
		}

		var infos = path.parse(file_path);
		var ext = infos.ext.toLowerCase();
		var code = content.toString();

		global.require = require;
		global.file_path = file_path;

		var split_dir = infos.dir.split(path.sep);
		var file_name = getFilename(infos);

		dependencies[file_name] = {
			running: false,
			file_path: file_path
		};

		switch(ext){
			case '.json':
			try{
				vm.runInThisContext(split_dir[split_dir.length-1].toLowerCase() + '.' + infos.name + ' = ' + code + ';');
				dependencies[file_name].running = true;
				EventEmitter.emit('check dependencies');
			}catch(e){
				try{
					vm.runInThisContext(split_dir[split_dir.length-1].toLowerCase() + ' = {};');
					vm.runInThisContext(split_dir[split_dir.length-1].toLowerCase() + '.' + infos.name + ' = ' + code + ';');
					dependencies[file_name].running = true;
					EventEmitter.emit('check dependencies');
				}catch(e){
					try{
						JSONParser.parse(code.replace(/(?:\/\*(?:[\s\S]*?)\*\/)|(?:\/\/(?:.*)$)/gm,
							function (match) {
								return new Array(match.split('\n').length).join('\n');
							}));
					}catch(e){
						dumpError(e);
					}
				}
			}
			break;

			case '.js':
			try{
				vm.runInThisContext(code);
				dependencies[file_name].running = true;
				EventEmitter.emit('check dependencies');
			}catch(e){
		      console.log(e);
		      if (!jshint(content.toString())) {
		        for (var i=0;i&lt;jshint.errors.length;i++) {
		          var e = jshint.errors[i];
		          if (!e) { continue; }
		        }
		      }
			}
			break;
		}

		delete global.file_path;
	});
};

/**
 * Function to return a file name based on directory and name.
 * @param  {object} infos Infos object.
 * @return {String}       Filename.
 */
function getFilename(infos){
	var split_dir = infos.dir.split(path.sep);
	// TODO: Consider adding a __dirname check if we wont name the file outside project directory.
	return split_dir[split_dir.length-1] + '/' + infos.name + infos.ext.toLowerCase();
}

/** 
 * Function used to watch the file or directory for changes.
 * @param  {String|Path} file_path The file path.
 * @param  {Object} opts      Options.
 */
VMScriptObj.prototype.watch = function(file_path, opts){
	file_path = path.resolve(file_path);
	if(array[file_path]) return;

	var directory = false;
	fs.stat(file_path, function(err, stats){
		if(err){
			dumpError(err);
			return;
		}

		fs.watch(file_path, function(){
			if(directory){
				fs.readdir(file_path, function(err, files){
					if(err){
						dumpError(err);
						return;
					}

					files = files.filter(function(file){
						var infos = path.parse(file_path + path.sep + file);
						return infos.ext !== '.tmp' &amp;&amp; infos.ext !== '.TMP';
					});

					for(var i=0; i&lt;files.length; i++){
						files[i] = file_path + path.sep + files[i];
						try{
							var stat = fs.statSync(files[i]);
							var index = array[file_path].files.indexOf(files[i]);
							if(index > -1){
								var prvStat = fileStats[files[i]];

								if(prvStat.mtime.getTime() !== stat.mtime.getTime()){
									fileStats[files[i]] = stat;
									EventEmitter.emit('file changed', files[i]);
								}
								continue;
							}

							array[file_path].files.push(files[i]);
							fileStats[files[i]] = stat;
							EventEmitter.emit('file added', files[i]);
						}catch(e){
							dumpError(e);
						}
					}

					for(var i=0; i&lt;array[file_path].files.length; i++){
						var f = array[file_path].files[i];
						try{
							fs.statSync(f);
						}catch(err){
							EventEmitter.emit('file removed', err.path);
							array[file_path].files.splice(
								array[file_path].files.indexOf(err.path),
								1
							);
						}
					}
				});
			}else{
				if(array[file_path]){
					fs.stat(file_path, function(err, stat){
						if(err){
							// delete array[file_path];
							// localEmitter.emit('file remove', err.path);
							// console.log('Removed file:', err.path);
							return;
						}

						var prvStat = array[file_path].stats;

						if(prvStat.mtime.getTime() !== stat.mtime.getTime()){
							array[file_path].stats = stat;
							EventEmitter.emit('file changed', file_path);
						}
					});
				}
			}
		});

		if(stats.isDirectory()){
			directory = true;
			array[file_path] = {
				files: []
			};

			var split_file_path = file_path.split(path.sep);
			dependencies[split_file_path[split_file_path.length-1]] = {
				files: [],
				running: false
			};

			fs.readdir(file_path, function(err, files){
				if(err){
					dumpError(err);
					return;
				}

				for(var i=0; i&lt;files.length; i++){
					var fp = file_path + path.sep + files[i];
					dependencies[split_file_path[split_file_path.length-1]].files.push(fp);
					array[file_path].files.push(fp);
					fileStats[fp] = fs.statSync(fp);
					EventEmitter.emit('file added', fp);
				}

				EventEmitter.emit('check dependencies');
			});
		}else if(stats.isFile()){
			array[file_path] = {
				stats: stats
			};

			EventEmitter.emit('file added', file_path);
		}
	});
	return this;
};

VMScriptObj.prototype.on = function(name, ready){
	if(typeof name === 'object'){
		var obj = {
			name: name,
			callback: ready,
			loaded: []
		};

		for(var n in name){
			var na = name[n];
			if ( (dependencies[na] &amp;&amp; dependencies[na].running) || this[na] !== undefined || global[na] !== undefined) {
				obj.loaded.push(na);
			}
		}

		if(obj.name.length === obj.loaded.length){
			obj.callback();
		}else{
			this.readyListeners.push(obj);
		}
	}else{
		var dependency = dependencies[name];
		if(dependency &amp;&amp; dependency.running){
			ready();
		}else{
			this.readyListeners.push({name: name, callback: ready});
		}
	}
};

/**
 * Exposes function to global scope for registering dependencies.
 * @param  {String}   name     The name of this vmscript.
 * @param  {String|Array}   depends  Dependencies.
 * @param  {Function} callback Call Back function to execute when dependencies are met.
 */
VMScriptObj.prototype.vms = function(name, depends, callback){
	// console.log(this.file_path);
	// console.log(name);
	dependencies[name] = {
		running: false,
		depends: depends,
		callback: callback
	};

	EventEmitter.emit('check dependencies');
};

/**
 * A module that exports methods to watch script files for changes.
 * And to load scripts at runtime.
 * @module vmscript
 */
module.exports = VMScriptObj;
</pre>
  </article>
</section>





        </div>

        <div class="clearfix"></div>
        <footer>
          
          
    <span class="copyright">
    The contributors to the InfiniteSky project.
    </span>
          <br />
          
    <span class="jsdoc-message">
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc" target="_blank">JSDoc 3.4.0</a>
    on Sat Jul 16th 2016
    </span>
        </footer>
      </div>

      <br clear="both">
    </div>

  </div>
  <!--<script src="scripts/sunlight.js"></script>-->
  <script src="scripts/docstrap.lib.js"></script>
  <script src="scripts/bootstrap-dropdown.js"></script>
  <script src="scripts/toc.js"></script>

  <script>
    $( function () {
      $( "[id*='$']" ).each( function () {
        var $this = $( this );

        $this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
      } );

      $( "#toc" ).toc( {
        anchorName  : function ( i, heading, prefix ) {
          return $( heading ).attr( "id" ) || ( prefix + i );
        },
        selectors   : "h1,h2,h3,h4",
        showAndHide : false,
        scrollTo    : "100px"
      } );

      $( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
      $( "#main span[id^='toc']" ).addClass( "toc-shim" );
      $( '.dropdown-toggle' ).dropdown();
//      $( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

      $( ".tutorial-section pre, .readme-section pre" ).each( function () {
        var $this = $( this );

        var example = $this.find( "code" );
        exampleText = example.html();
        var lang = /{@lang (.*?)}/.exec( exampleText );
        if ( lang && lang[1] ) {
          exampleText = exampleText.replace( lang[0], "" );
          example.html( exampleText );
          lang = lang[1];
        } else {
          lang = "javascript";
        }

        if ( lang ) {

          $this
            .addClass( "sunlight-highlight-" + lang )
            .addClass( "linenums" )
            .html( example.html() );

        }
      } );

      Sunlight.highlightAll( {
        lineNumbers : true,
        showMenu : true,
        enableDoclinks : true
      } );
    } );
   </script>



  <!--Navigation and Symbol Display-->
  


  <!--Google Analytics-->
  

</body>
</html>
